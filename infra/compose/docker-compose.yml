networks:
  bloodhound-net:
    driver: bridge
  midpoint-net:
    driver: bridge
    internal: true

volumes:
  neo4j-data:
  postgres-data:
  midpoint-postgres-data:
  thehive-cassandra-data:
  thehive-elasticsearch-data:
  thehive-data:

services:
  thehive-cassandra:
    image: cassandra:4.1
    container_name: thehive-cassandra
    restart: unless-stopped
    environment:
      - CASSANDRA_CLUSTER_NAME=thehive
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - MAX_HEAP_SIZE=256M
      - HEAP_NEWSIZE=64M
    volumes:
      - thehive-cassandra-data:/var/lib/cassandra
    networks:
      - bloodhound-net

  thehive-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.18
    container_name: thehive-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    # Publish 9200 locally to support health checks (e.g. `curl http://localhost:9200`).
    # Bound to loopback to avoid exposing Elasticsearch beyond this host.
    ports:
      - "127.0.0.1:9200:9200"
    volumes:
      - thehive-elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - bloodhound-net

  thehive:
    # NOTE: Avoid the legacy floating :5 tag (old 5.0.x builds). Pin a supported
    # release series/tag for predictable behavior and security updates.
    image: strangebee/thehive:5.5.13-1
    container_name: thehive
    restart: unless-stopped
    depends_on:
      - thehive-cassandra
      - thehive-elasticsearch
    command:
      - --secret
      # TheHive 5.5+ (Play) requires an application secret with enough entropy for HS256.
      # Provide it via the repo-root .env (copy from .env.example). Minimum practical: 32+ bytes.
      - ${THEHIVE_SECRET:?Set THEHIVE_SECRET in repo-root .env (min 32+ bytes)}
      - --cql-hostnames
      - thehive-cassandra
      - --es-hostnames
      - thehive-elasticsearch
      - --no-config-cortex
      - --storage-directory
      - /data/files
    volumes:
      - thehive-data:/data
      - ./thehive/application.conf:/etc/thehive/application.conf:ro
    expose:
      - "9000"
    networks:
      - bloodhound-net

  neo4j:
    image: neo4j:4.4
    container_name: bloodhound-neo4j
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/bloodhoundcommunityedition}
      - NEO4J_dbms_memory_heap_initial__size=512M
      - NEO4J_dbms_memory_heap_max__size=512M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "PASS=$(printf '%s' \"$$NEO4J_AUTH\" | cut -d/ -f2-); cypher-shell -u neo4j -p \"$$PASS\" 'RETURN 1' >/dev/null 2>&1",
        ]
      interval: 10s
      timeout: 5s
      retries: 30
    volumes:
      - neo4j-data:/data
    networks:
      bloodhound-net:
        aliases:
          - graph-db

  postgres:
    image: postgres:14
    container_name: bloodhound-postgres
    environment:
      - POSTGRES_USER=${BH_POSTGRES_USER:-bloodhound}
      - POSTGRES_PASSWORD=${BH_POSTGRES_PASSWORD:-bloodhoundcommunityedition}
      - POSTGRES_DB=${BH_POSTGRES_DATABASE:-bloodhound}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$$POSTGRES_USER\" -d \"$$POSTGRES_DB\" -h 127.0.0.1 >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 30
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      bloodhound-net:
        aliases:
          - app-db

  bloodhound:
    image: specterops/bloodhound:5.0.10
    container_name: bloodhound-app
    restart: unless-stopped
    depends_on:
      neo4j:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - GOMEMLIMIT=512MiB
      - WEB_PORT=80
      - BH_API_PORT=8008
      - BH_HOSTNAME=bloodhound.local
      - BH_ADMIN_EMAIL=admin@bloodhoundenterprise.io
      - BH_ADMIN_PASSWORD=${BH_ADMIN_PASSWORD:-change-me}
      - BH_NEO4J_HOSTNAME=neo4j
      - BH_NEO4J_AUTH=${NEO4J_AUTH:-neo4j/bloodhoundcommunityedition}
      - BH_NEO4J_PORT=7687
      - BH_NEO4J_WEB_PORT=7474
      - BH_POSTGRES_USER=${BH_POSTGRES_USER:-bloodhound}
      - BH_POSTGRES_PASSWORD=${BH_POSTGRES_PASSWORD:-bloodhoundcommunityedition}
      - BH_POSTGRES_DATABASE=${BH_POSTGRES_DATABASE:-bloodhound}
      - BH_POSTGRES_HOST=postgres
      - BH_POSTGRES_PORT=5432
    expose:
      - "80"
      - "8008"
    volumes:
      - ../docker/bloodhound/bloodhound.config.json:/bloodhound.config.json:ro
    networks:
      - bloodhound-net

  proxy:
    image: nginx:1.25
    container_name: bloodhound-proxy
    depends_on:
      - bloodhound
      - bloodhound-embed-gateway
      - thehive
    volumes:
      - ../docker/bloodhound/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ../docker/bloodhound/proxy-entrypoint.sh:/proxy-entrypoint.sh:ro
      - ../docker/bloodhound/itdr-embed.js:/etc/nginx/itdr-embed.js:ro
    ports:
      - "8080:80"
    environment:
      - BLOODHOUND_INTERNAL_TOKEN=${BLOODHOUND_INTERNAL_TOKEN:-}
      - BLOODHOUND_INTERNAL_LOGIN_USERNAME=${BLOODHOUND_INTERNAL_LOGIN_USERNAME:-admin}
      - BLOODHOUND_INTERNAL_LOGIN_SECRET=${BLOODHOUND_INTERNAL_LOGIN_SECRET:-${BH_ADMIN_PASSWORD:-change-me}}
      - MIDPOINT_USERNAME=${MIDPOINT_USERNAME:-administrator}
      - MIDPOINT_PASSWORD=${MIDPOINT_PASSWORD:-change-me}
    command: ["/bin/sh", "/proxy-entrypoint.sh"]
    networks:
      - bloodhound-net

  bloodhound-embed-gateway:
    image: python:3.12-slim
    container_name: bloodhound-embed-gateway
    restart: unless-stopped
    environment:
      - PORT=8082
    volumes:
      - ../../services/bloodhound-embed-gateway:/srv:ro
    working_dir: /srv
    command: ["python", "server.py"]
    expose:
      - "8082"
    networks:
      - bloodhound-net

  midpoint-postgres:
    image: postgres:14
    container_name: midpoint-postgres
    environment:
      - POSTGRES_USER=${MP_POSTGRES_USER:-midpoint}
      - POSTGRES_PASSWORD=${MP_POSTGRES_PASSWORD:-change-me}
      - POSTGRES_DB=${MP_POSTGRES_DB:-midpoint}
    volumes:
      - midpoint-postgres-data:/var/lib/postgresql/data
    networks:
      - midpoint-net

  midpoint:
    image: evolveum/midpoint:4.10
    container_name: midpoint-app
    depends_on:
      - midpoint-postgres
    environment:
      - MP_DATABASE_HOST=midpoint-postgres
      - MP_DATABASE_PORT=5432
      - MP_DATABASE_NAME=${MP_POSTGRES_DB:-midpoint}
      - MP_DATABASE_USER=${MP_POSTGRES_USER:-midpoint}
      - MP_DATABASE_PASSWORD=${MP_POSTGRES_PASSWORD:-change-me}
    expose:
      - "8080"
    networks:
      - midpoint-net
      - bloodhound-net

  identity-governance-adapter:
    image: python:3.12-slim
    container_name: identity-governance-adapter
    depends_on:
      - midpoint
    environment:
      - MIDPOINT_BASE_URL=http://midpoint:8080
      - MIDPOINT_USERNAME=${MIDPOINT_USERNAME:-administrator}
      - MIDPOINT_PASSWORD=${MIDPOINT_PASSWORD:-change-me}
    volumes:
      - ../../integrations/identity-governance-adapter:/app
    working_dir: /app
    command: ["python", "-c", "print('identity-governance-adapter container ready')"]
    networks:
      - midpoint-net

  identity-governance-adapter-api:
    image: python:3.12-slim
    container_name: identity-governance-adapter-api
    depends_on:
      - midpoint
    environment:
      - MIDPOINT_BASE_URL=http://midpoint:8080
      - MIDPOINT_USERNAME=${MIDPOINT_USERNAME:-administrator}
      - MIDPOINT_PASSWORD=${MIDPOINT_PASSWORD:-change-me}
      - ADAPTER_PATH=/app/client.py
      - PORT=8090
    volumes:
      - ../../integrations/identity-governance-adapter:/app
      - ../identity-governance-adapter-api:/srv:ro
    working_dir: /srv
    command: ["python", "server.py"]
    expose:
      - "8090"
    networks:
      - midpoint-net
      - bloodhound-net

